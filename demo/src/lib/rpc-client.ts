// This file is auto-generated by vercel-rpc-cli. Do not edit manually.
// Re-run `rpc generate` or use `rpc watch` to regenerate.

import type {
	Procedures,
	EchoInput,
	EchoOutput,
	MathInput,
	MathResult,
	ServiceStatus,
	Stats,
	TimeResponse,
	HealthStatus,
	Operation
} from './rpc-types';

export type {
	Procedures,
	EchoInput,
	EchoOutput,
	MathInput,
	MathResult,
	ServiceStatus,
	Stats,
	TimeResponse,
	HealthStatus,
	Operation
};

export class RpcError extends Error {
	readonly status: number;
	readonly data: unknown;

	constructor(status: number, message: string, data?: unknown) {
		super(message);
		this.name = 'RpcError';
		this.status = status;
		this.data = data;
	}
}

async function rpcFetch(
	baseUrl: string,
	method: 'GET' | 'POST',
	procedure: string,
	input?: unknown
): Promise<unknown> {
	let url = `${baseUrl}/${procedure}`;
	const init: RequestInit = { method, headers: {} };

	if (method === 'GET' && input !== undefined) {
		url += `?input=${encodeURIComponent(JSON.stringify(input))}`;
	} else if (method === 'POST' && input !== undefined) {
		init.body = JSON.stringify(input);
		(init.headers as Record<string, string>)['Content-Type'] = 'application/json';
	}

	const res = await fetch(url, init);

	if (!res.ok) {
		let data: unknown;
		try {
			data = await res.json();
		} catch {
			data = await res.text().catch(() => null);
		}
		throw new RpcError(
			res.status,
			`RPC error on "${procedure}": ${res.status} ${res.statusText}`,
			data
		);
	}

	const json = await res.json();
	return json?.result?.data ?? json;
}

type QueryKey = keyof Procedures['queries'];
type MutationKey = keyof Procedures['mutations'];
type QueryInput<K extends QueryKey> = Procedures['queries'][K]['input'];
type QueryOutput<K extends QueryKey> = Procedures['queries'][K]['output'];
type MutationInput<K extends MutationKey> = Procedures['mutations'][K]['input'];
type MutationOutput<K extends MutationKey> = Procedures['mutations'][K]['output'];

export interface RpcClient {
	query(key: 'status'): Promise<ServiceStatus>;
	query(key: 'time'): Promise<TimeResponse>;
	query(key: 'hello', input: string): Promise<string>;
	query(key: 'math', input: MathInput): Promise<MathResult>;
	query(key: 'stats', input: number[]): Promise<Stats>;

	mutate(key: 'echo', input: EchoInput): Promise<EchoOutput>;
}

export function createRpcClient(baseUrl: string): RpcClient {
	return {
		query(key: QueryKey, ...args: unknown[]): Promise<unknown> {
			return rpcFetch(baseUrl, 'GET', key, args[0]);
		},
		mutate(key: MutationKey, ...args: unknown[]): Promise<unknown> {
			return rpcFetch(baseUrl, 'POST', key, args[0]);
		}
	} as RpcClient;
}
